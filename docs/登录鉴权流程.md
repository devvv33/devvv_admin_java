# 登录鉴权流程

## 框架 Sa-Token
    框架文档: https://sa-token.cc/doc.html

---

## 一、用户体系说明

本系统分为2个用户体系：

| 用户类型 | 工具类 | Token标识 | 适用场景 |
|---------|--------|----------|---------|
| Admin | `StpAdminUtil` | `admin` | CMS后台管理用户 |
| User | `StpUserUtil` | `user` | App端普通用户 |

**核心设计**: 不同账号体系使用不同的工具类来操作  
参考: https://sa-token.cc/doc.html#/up/many-account

---

## 二、路由权限控制

| 路由前缀 | 权限要求 | 配置位置 |
|---------|---------|---------|
| `/api/**` | 必须 User 用户登录 | `SaTokenConfiguration` |
| `/cmsApi/**` | 必须 Admin 用户登录 | `CmsSaTokenConfig` |
| `/inner/**` | 内部服务调用（需 SameToken） | `SaTokenConfiguration` |

**注意**: 不以上述前缀开头的接口，不需要校验可直接访问
    我们应该在更上层拦截非上述前缀的接口, 如Nginx、Gateway只转发上述前缀接口

---

## 三、核心配置

### 3.1 Token 配置

位置: `commons-support-sa-token/.../config/SaTokenConfiguration.java`

```java
// CMS Admin 配置
SaTokenConfig adminConfig = new SaTokenConfig();
adminConfig.setTokenName("cms_token");          // Token 名称
adminConfig.setTimeout(24 * 60 * 60);           // 有效期 24 小时
adminConfig.setIsConcurrent(true);              // 允许多地同时登录
adminConfig.setIsShare(true);                   // 共用同一个 Token

// App User 配置
SaTokenConfig userConfig = new SaTokenConfig();
userConfig.setTokenName("sid");                 // Token 名称
userConfig.setTimeout(30 * 24 * 60 * 60);       // 有效期 30 天
userConfig.setIsConcurrent(false);              // 同端互斥登录
userConfig.setIsShare(false);                   // 每次登录新建 Token
userConfig.setTokenStyle("random-64");          // Token 风格
```

### 3.2 拦截器配置

**全局配置** (`SaTokenConfiguration`):

```java
@Override
public void addInterceptors(InterceptorRegistry registry) {
    // 检查 Token
    registry.addInterceptor(new SaInterceptor(handler -> {
        // /api/** 需要 User 登录
        SaRouter.match("/api/**")
                .check(r -> StpUserUtil.checkLogin())
                .check(r -> ClientInfoUtil.checkClient());

        // /inner/** 内部服务调用校验
        SaRouter.match("/inner/**")
                .check(r -> SaSameUtil.checkCurrentRequestToken());
    })).addPathPatterns("/**");

    // 解析 Token 用户信息
    registry.addInterceptor(new ParseTokenUserInterceptor())
            .addPathPatterns("/api/**", "/cmsApi/**");
}
```

**CMS 模块配置** (`CmsSaTokenConfig`):

```java
@Override
public void addInterceptors(InterceptorRegistry registry) {
    registry.addInterceptor(new SaInterceptor(handler -> {
        // /cmsApi/** 需要 Admin 登录
        SaRouter.match("/cmsApi/**")
                .check(r -> StpAdminUtil.checkLogin())
                .check(r -> ClientInfoUtil.checkClient());

        // 接口权限校验（非超级管理员）
        if (!StpAdminUtil.hasRole(RoleUtil.ROLE_SUPER_ADMIN)) {
            String requestPath = SaHolder.getRequest().getRequestPath();
            if (MenuManager.getInstance().listAllPermission().contains(requestPath)) {
                StpAdminUtil.checkPermission(requestPath);
            }
        }
    })).addPathPatterns("/**");
}
```

---

## 四、请求处理流程

```
请求进入
    ↓
┌─────────────────────────────────────────────────────────┐
│ RootFilter (所有请求)                                     │
│ - 初始化 BusiContext                                      │
│ - 设置 traceId、请求时间、客户端IP等                         │
└─────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────┐
│ ApiFilter (/api/*, /cmsApi/*)                           │
│ - 解析客户端信息 (ClientInfo)                              │
│ - 解析请求头 x-inf、x-arg                                  │
└─────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────┐
│ SaInterceptor (Sa-Token 拦截器)                          │
│ - 登录校验 (checkLogin)                                   │
│ - 客户端校验 (checkClient)                                │
│ - 权限校验 (checkPermission) - 仅 CMS                     │
└─────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────┐
│ ParseTokenUserInterceptor                               │
│ - 从 Token 解析用户信息                                    │
│ - 将用户信息写入 BusiContext                               │
└─────────────────────────────────────────────────────────┘
    ↓
Controller 处理业务
```

---

## 五、登录流程实现

### 5.1 登录接口示例

**登录接口需放开校验**，使用 `@SaIgnore` 注解：

```java
@Operation(summary = "手机号登录")
@SaIgnore  // 放开登录校验
@PostMapping("/loginByMobile")
public Result<UserLoginVO> loginByMobile(@Valid @RequestBody LoginByMobileForm form) {
    ClientInfoUtil.checkClient();  // 手动校验客户端
    return Result.success(loginService.loginByMobile(form));
}
```

### 5.2 Admin 用户登录 (CMS)

参考: `CmsLoginService.loginByUsername()`

```java
public CmsLoginInfoVO loginByUsername(LoginByUsernameForm form) {
    CmsAdminUser admin = adminUserManager.getByUsername(form.getUsername());

    // 调用 StpAdminUtil 的登录方法
    StpAdminUtil.login(admin.getAdminId());
    return getLoginInfo();
}
```

### 5.3 User 用户登录 (App)

参考: `UserLoginService.loginByMobile()`

```java
public UserLoginVO loginByMobile(LoginByMobileForm form) {
    UUserMobile userMobile = userMobileMapper.getByMobile(form.getMobile());

    // 调用 StpUserUtil 的登录方法
    StpUserUtil.login(userBasic.getUserId(), clientType.getId());
    return getLoginInfo();
}
```

### 5.4 退出登录

```java
// Admin 退出
StpAdminUtil.logout();

// User 退出
StpUserUtil.logout();
```

---

## 六、业务中获取当前用户

### 6.1 从 BusiContext 获取（推荐）

```java
// 获取当前 Admin 用户ID
Long adminId = BusiContextUtil.getAdminId();

// 获取当前 Admin 用户会话信息
AdminSessionInfo adminSession = BusiContextUtil.getAdminSessionCopy();

// 获取当前 User 用户ID
Long userId = BusiContextUtil.getUserId();

// 获取当前 User 用户会话信息
UserSessionInfo userSession = BusiContextUtil.getUserSessionCopy();
```

### 6.2 从 StpUtil 获取

```java
// Admin
Long adminId = StpAdminUtil.getLoginId();
boolean isLogin = StpAdminUtil.isLogin();

// User
Long userId = StpUserUtil.getLoginId();
boolean isLogin = StpUserUtil.isLogin();
```

---

## 七、客户端校验

系统要求请求必须携带客户端信息，防止非法请求：

### 7.1 请求头说明

| 请求头 | 说明 |
|--------|------|
| `x-inf` | 客户端信息（可加密） |
| `x-arg` | AES 密钥（RSA 加密） |

### 7.2 校验内容

```java
public static void checkClient() {
    ClientInfo clientInfo = BusiContextUtil.getContext().getClientInfo();
    
    // 1. 必须有 x-inf 请求头
    Assert.notNull(clientInfo, "缺少请求头 x-inf");
    
    // 2. 生产环境必须加密
    if (ApplicationInfo.isProdEnv()) {
        Assert.notNull(clientInfo.getAesKey(), "缺少请求头 x-arg");
    }
    
    // 3. 客户端时间校验（5 分钟内）
    // ...
    
    // 4. 防重放攻击（60 秒内 nonce 不能重复）
    // ...
}
```

---

## 八、异常处理

位置: `GlobalTokenExceptionHandler`

```java
@ExceptionHandler
public ResponseEntity<Result> handlerException(SaTokenException e) {
    Result result = null;
    
    // 未登录
    if (e instanceof NotLoginException) {
        result = Result.build(ErrorCode.UN_AUTH);
    }
    // 无角色或无权限
    if (e instanceof NotRoleException || e instanceof NotPermissionException) {
        result = Result.build(ErrorCode.NO_PERMISSION);
    }
    // 内部调用 Token 无效
    if (e instanceof SameTokenInvalidException) {
        result = Result.build(ErrorCode.NOT_INNER_CLIENT);
    }
    
    return ResponseEntity.status(HttpStatus.OK)
            .contentType(MediaType.APPLICATION_JSON)
            .body(result);
}
```

---

## 九、新增接口前缀

如需新增需要鉴权的接口前缀，请修改以下配置：

1. **全局配置**: `SaTokenConfiguration.addInterceptors()`
2. **CMS 配置**: `CmsSaTokenConfig.addInterceptors()`
3. **Token 解析**: `ParseTokenUserInterceptor.URL_PATTERN`
4. **API 过滤器**: `ApiFilter.URL_PATTERN`

---

## 十、文件索引

| 文件 | 说明 |
|------|------|
| `commons-support-sa-token/.../utils/StpAdminUtil.java` | Admin 用户工具类 |
| `commons-support-sa-token/.../utils/StpUserUtil.java` | User 用户工具类 |
| `commons-support-sa-token/.../config/SaTokenConfiguration.java` | 全局 Token 配置 |
| `commons-support-sa-token/.../interceptor/ParseTokenUserInterceptor.java` | Token 解析拦截器 |
| `commons-support-sa-token/.../handler/GlobalTokenExceptionHandler.java` | Token 异常处理 |
| `commons-support-web/.../filter/RootFilter.java` | 根过滤器 |
| `commons-support-web/.../filter/ApiFilter.java` | API 过滤器 |
| `commons-core/.../context/BusiContext.java` | 业务上下文 |
| `commons-core/.../context/BusiContextHolder.java` | 上下文持有者 |
| `commons-core/.../context/ClientInfoUtil.java` | 客户端信息工具 |
| `cms-biz/.../config/CmsSaTokenConfig.java` | CMS 模块 Token 配置 |
| `cms-biz/.../service/cms/CmsLoginService.java` | CMS 登录服务 |
| `user-biz/.../service/UserLoginService.java` | User 登录服务 |