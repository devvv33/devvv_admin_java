# 表缓存设计文档

## 1. 概述

表缓存是一个基于 Redis 的数据库表级别缓存方案，通过 AOP 拦截 Mapper 方法，自动管理缓存的读取、写入和失效。

### 核心效果

- **查询优先缓存**：数据库查询时，优先查询表缓存
- **缓存穿透保护**：表缓存不存在时，从数据库加载，然后加入到表缓存
- **事务一致性保证**：在事务场景中，缓存更新操作会被暂存到缓冲区，等待事务提交后批量执行；事务回滚时自动清空缓冲区

### 前置条件

环境中必须引入 TableRedis 缓存配置，否则表缓存将不会生效（参看：`TableCacheAutoConfig`）

---

## 2. 核心组件架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              表缓存架构图                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────┐                                                       │
│   │  Mapper 调用     │                                                       │
│   └────────┬────────┘                                                       │
│            │                                                                │
│            ▼                                                                │
│   ┌─────────────────┐                                                       │
│   │ TableCacheAspect│ ◄──── AOP 切面，拦截 Mapper 方法                       │
│   └────────┬────────┘                                                       │
│            │                                                                │
│            ▼                                                                │
│   ┌─────────────────┐                                                       │
│   │  CacheExecutor  │ ◄──── 表缓存执行器，核心业务逻辑                        │
│   └────────┬────────┘                                                       │
│            │                                                                │
│            ▼                                                                │
│   ┌─────────────────┐                                                       │
│   │  CacheManager   │ ◄──── 缓存管理器，负责序列化/反序列化                    │
│   └────────┬────────┘                                                       │
│            │                                                                │
│            ▼                                                                │
│   ┌─────────────────┐       ┌─────────────────────────────────────────┐     │
│   │   BufferedCache │──────►│ BufferedTableCacheTransactionResource   │     │
│   │   (装饰器模式)   │       │           (事务资源绑定)                  │     │
│   └────────┬────────┘       └─────────────────────────────────────────┘     │
│            │                                                                │
│            ▼                                                                │
│   ┌─────────────────┐                                                       │
│   │   RedisCache    │ ◄──── Redis 缓存实现                                  │
│   └────────┬────────┘                                                       │
│            │                                                                │
│            ▼                                                                │
│   ┌─────────────────┐                                                       │
│   │     Redis       │ ◄──── TableRedis                                           │
│   └─────────────────┘                                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 组件职责说明

| 组件 | 职责 |
|------|------|
| `TableCacheAspect` | AOP 切面，拦截标记了 `@Table` 的 Mapper 方法 |
| `CacheExecutor` | 表缓存处理的核心逻辑，协调缓存读写和数据库操作 |
| `CacheManager` | 缓存管理器，负责序列化/反序列化和缓存 CRUD 操作 |
| `BufferedCache` | 装饰器模式实现，在事务场景下缓冲命令 |
| `RedisCache` | Redis 缓存的具体实现 |
| `BufferedTableCacheTransactionResource` | 事务资源绑定，维护命令缓冲区 |

---

## 3. 调用链详解

### 3.1 整体调用链

```
Mapper 方法调用
       │
       ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  TableCacheAspect                                                        │
│  ├── 检查 @Table 注解是否启用缓存                                         │
│  ├── 构建缓存 Key                                                        │
│  └── 委托给 CacheExecutor 处理                                           │
└──────────────────────────────────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  CacheExecutor                                                           │
│  ├── selectByPrimaryKey: 先查缓存 → 缓存未命中则查数据库 → 写入缓存          │
│  ├── insert/update/delete: 执行数据库操作 → 删除缓存                       │
│  └── 调用 CacheManager 执行缓存操作                                       │
└──────────────────────────────────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  CacheManager                                                            │
│  ├── save(): 序列化对象 → 调用 ICache.set/setex                           │
│  ├── get(): 调用 ICache.get → 反序列化对象                                │
│  └── delete(): 调用 ICache.del                                           │
└──────────────────────────────────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  BufferedCache (ICache 装饰器)                                           │
│  ├── 判断是否在事务中: BusiTransactionResourceManager.inTransaction()     │
│  ├── 非事务场景: 直接委托给 RedisCache 执行                                │
│  └── 事务场景: 将命令添加到缓冲区                                          │
└──────────────────────────────────────────────────────────────────────────┘
       │
       ├── 非事务 ──────────────────────┐
       │                               ▼
       │                    ┌──────────────────────┐
       │                    │      RedisCache      │
       │                    │   直接执行 Redis 命令  │
       │                    └──────────────────────┘
       │
       └── 事务场景 ─────────────────────┐
                                        ▼
                     ┌────────────────────────────────────────────┐
                     │  BufferedTableCacheTransactionResource     │
                     │  ├── 命令加入 buffer (List<Command>)        │
                     │  ├── 事务提交时: commit() 批量执行命令        │
                     │  └── 事务回滚时: rollback() 清空缓冲区        │
                     └────────────────────────────────────────────┘
```

### 3.2 拦截的方法

`TableCacheAspect` 拦截以下 Mapper 方法：

| 方法 | 切面方法 | 缓存处理逻辑 |
|------|---------|-------------|
| `insert*` | `insert()` | 执行插入后删除缓存 |
| `updateByPrimaryKey` | `updateByPrimaryKey()` | 执行更新后删除缓存 |
| `updateByPrimaryKeySelective` | `updateByPrimaryKeySelective()` | 执行更新后删除缓存 |
| `deleteByPrimaryKey` | `deleteByPrimaryKey()` | 执行删除后删除缓存 |
| `selectByPrimaryKey` | `selectByPrimaryKey()` | 先查缓存，未命中则查库并缓存 |
| `@SelectAll` 标记的方法 | `selectAll()` | 先查缓存，未命中则查库并缓存 |

### 3.3 缓存 Key 构建规则

```java
// 主键查询的缓存 Key
"{Mapper名}:{主键值}"
// 示例: "AdminUserMapper:1001"

// 复合主键的缓存 Key
"{Mapper名}:{主键1}_{主键2}"
// 示例: "UserRoleMapper:1001_admin"

// SelectAll 的缓存 Key
"{Mapper名}:#:_ALL_"
// 示例: "AdminUserMapper:#:_ALL_"
```

---

## 4. 事务场景中的更新逻辑

### 4.1 事务资源管理架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          事务资源管理架构                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────┐                                               │
│   │   @Transactional        │                                               │
│   │   业务方法               │                                               │
│   └───────────┬─────────────┘                                               │
│               │                                                             │
│               ▼                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                   BusiTransactionManager                            │   │
│   │   (继承 MultiDatasourceTransactionManager)                          │   │
│   │                                                                     │   │
│   │   getTransaction()                                                  │   │
│   │   ├── 调用父类开启事务                                                │   │
│   │   ├── BusiTransactionResourceManager.initTransactionResource()     │   │
│   │   └── 初始化 ThreadLocal<LinkedHashMap> 用于存储事务资源              │   │
│   │                                                                     │   │
│   │   commit()                                                          │   │
│   │   ├── 调用父类提交数据库事务                                          │   │
│   │   └── triggerCommit() → 遍历所有资源调用 resource.commit()           │   │
│   │                                                                     │   │
│   │   rollback()                                                        │   │
│   │   ├── 调用父类回滚数据库事务                                          │   │
│   │   └── triggerRollback() → 遍历所有资源调用 resource.rollback()       │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│               ▲                                                             │
│               │ 绑定资源                                                    │
│               │                                                             │
│   ┌───────────┴──────────────────────────────────────────────────────────┐  │
│   │              BusiTransactionResourceManager                          │  │
│   │   ThreadLocal<LinkedHashMap<Object, BusiTransactionResource>>        │  │
│   │                                                                      │  │
│   │   ├── inTransaction(): 判断是否在事务中                               │  │
│   │   ├── bindResource(key, resource): 绑定事务资源                       │  │
│   │   └── getResource(key): 获取事务资源                                  │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│               ▲                                                             │
│               │ 自动绑定                                                    │
│               │                                                             │
│   ┌───────────┴──────────────────────────────────────────────────────────┐  │
│   │           BufferedTableCacheTransactionResource                      │  │
│   │           (实现 BusiTransactionResource 接口)                         │  │
│   │                                                                      │  │
│   │   buffer: List<Command>  ←── 缓存命令缓冲区                           │  │
│   │                                                                      │  │
│   │   addCommand(Command): 添加缓存命令到缓冲区                           │  │
│   │   getLastFromBuffer(key): 从缓冲区获取最新命令（用于读取未提交的值）    │  │
│   │   commit(): 批量提交所有命令到 Redis                                  │  │
│   │   rollback(): 清空缓冲区                                             │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 事务场景下的缓存更新流程

#### 4.2.1 事务开始

```
@Transactional 方法开始
        │
        ▼
BusiTransactionManager.getTransaction()
        │
        ├── 1. 调用父类开启数据库事务
        │
        └── 2. BusiTransactionResourceManager.initTransactionResource()
                   │
                   └── 创建 ThreadLocal<LinkedHashMap> 用于存储事务资源
```

#### 4.2.2 事务中执行缓存操作

```
业务代码调用 Mapper 方法 (例如 updateByPrimaryKey)
        │
        ▼
TableCacheAspect 拦截
        │
        ▼
CacheExecutor.updateByPrimaryKey()
        │
        ├── 1. 执行数据库更新
        │
        └── 2. 调用 CacheManager.delete(key)
                   │
                   ▼
            BufferedCache.del(key)
                   │
                   ├── 检查: BusiTransactionResourceManager.inTransaction()
                   │                    │
                   │                    └── 返回 true (在事务中)
                   │
                   └── 将删除命令加入缓冲区:
                       getResource().addCommand(Command.newDelCommand(key))
                                │
                                ▼
                       BufferedTableCacheTransactionResource
                                │
                                ├── 首次调用时自动创建并绑定到事务资源管理器
                                │
                                └── 命令加入 buffer: List<Command>
```

#### 4.2.3 事务中读取缓存（读取未提交的变更）

在事务中读取缓存时，`BufferedCache` 会优先从缓冲区查找最新的值：

```java
// BufferedCache.get() 的逻辑
public String get(String cacheKey) throws CacheException {
    if (!BusiTransactionResourceManager.inTransaction()) {
        return delegate.get(cacheKey);  // 非事务：直接查 Redis
    }
    
    // 事务场景：优先从缓冲区获取
    Command command = getResource().getLastFromBuffer(cacheKey);
    
    if (command == null) {
        return delegate.get(cacheKey);  // 缓冲区无此 key，查 Redis
    }
    
    if (command.getOp() == Command.Operation.DEL) {
        return null;  // 如果是删除命令，返回 null
    }
    
    return command.getCacheValue();  // 返回缓冲区中的最新值
}
```

#### 4.2.4 事务提交

```
@Transactional 方法正常结束
        │
        ▼
BusiTransactionManager.commit()
        │
        ├── 1. super.commit() - 提交数据库事务
        │
        └── 2. triggerCommit() - 触发所有事务资源的提交
                   │
                   ▼
            遍历 BusiTransactionResourceManager.getResourceMap()
                   │
                   ▼
            BufferedTableCacheTransactionResource.commit()
                   │
                   ├── 创建 CommandParser 解析所有命令
                   │
                   └── 批量提交到 Redis:
                       │
                       ├── 优先尝试 Redis 事务模式:
                       │   redisTemplate.execute(SessionCallback {
                       │       operations.multi();
                       │       commandParser.submitCommand(operations);
                       │       operations.exec();
                       │   })
                       │
                       └── 如果不支持事务，降级为 Pipeline 模式:
                           redisTemplate.executePipelined(SessionCallback {
                               commandParser.submitCommand(operations);
                           })
```

#### 4.2.5 事务回滚

```
@Transactional 方法抛出异常
        │
        ▼
BusiTransactionManager.rollback()
        │
        ├── 1. super.rollback() - 回滚数据库事务
        │
        └── 2. triggerRollback() - 触发所有事务资源的回滚
                   │
                   ▼
            遍历 BusiTransactionResourceManager.getResourceMap()
                   │
                   ▼
            BufferedTableCacheTransactionResource.rollback()
                   │
                   └── buffer.clear() - 直接清空缓冲区，不执行任何 Redis 命令
```

### 4.3 命令缓冲区的优化处理

`BufferedTableCacheTransactionResource` 对命令缓冲区做了以下优化：

#### 4.3.1 删除命令优先级

如果缓冲区中已有某个 key 的删除命令，后续对该 key 的 SET 命令将被忽略：

```java
public void addCommand(Command command) {
    // 如果 buffer 中已有删除命令，不再添加 set 命令
    if (buffer.stream()
            .filter(cmd -> cmd.getOp() == Command.Operation.DEL)
            .anyMatch(cmd -> cmd.getCacheKey().equals(command.getCacheKey()))) {
        return;
    }
    buffer.add(command);
}
```

#### 4.3.2 读取最新值

从缓冲区获取值时，优先返回删除命令（表示数据已被删除），然后倒序查找最新的 SET 命令：

```java
public Command getLastFromBuffer(String cacheKey) {
    // 优先返回删除命令
    Command deleteCmd = buffer.stream()
            .filter(cmd -> cmd.getOp() == Command.Operation.DEL)
            .filter(cmd -> cmd.getCacheKey().equals(cacheKey))
            .findAny().orElse(null);
    if (deleteCmd != null) {
        return deleteCmd;
    }

    // 倒序查找最新的 SET 命令
    for (int i = buffer.size() - 1; i >= 0; i--) {
        Command command = buffer.get(i);
        // ... 处理 SETS 等批量操作
        if (cacheKey.equals(command.getCacheKey())) {
            return command;
        }
    }
    return null;
}
```

### 4.4 时序图：事务场景下的完整流程

```
┌─────────┐   ┌────────────────┐   ┌─────────────┐   ┌─────────────┐   ┌───────────────────────────────────────┐   ┌───────┐
│  业务层  │   │BusiTransaction │   │BufferedCache│   │ RedisCache  │   │BufferedTableCacheTransactionResource  │   │ Redis │
│         │   │    Manager     │   │             │   │             │   │                                       │   │       │
└────┬────┘   └───────┬────────┘   └──────┬──────┘   └──────┬──────┘   └───────────────────┬───────────────────┘   └───┬───┘
     │                │                   │                 │                              │                           │
     │  开启事务       │                   │                 │                              │                           │
     │───────────────>│                   │                 │                              │                           │
     │                │ initResource()    │                 │                              │                           │
     │                │──────────────────────────────────────────────────────────────────>│                           │
     │                │                   │                 │                              │                           │
     │  更新数据       │                   │                 │                              │                           │
     │───────────────────────────────────>│                 │                              │                           │
     │                │                   │  inTransaction? │                              │                           │
     │                │                   │────────────────>│                              │                           │
     │                │                   │       true      │                              │                           │
     │                │                   │<────────────────│                              │                           │
     │                │                   │                 │                              │                           │
     │                │                   │  addCommand(DEL)│                              │                           │
     │                │                   │─────────────────────────────────────────────>│                           │
     │                │                   │                 │                              │ 加入缓冲区                 │
     │                │                   │                 │                              │                           │
     │  查询数据       │                   │                 │                              │                           │
     │───────────────────────────────────>│                 │                              │                           │
     │                │                   │ getLastFromBuffer                              │                           │
     │                │                   │─────────────────────────────────────────────>│                           │
     │                │                   │      DEL cmd    │                              │                           │
     │                │                   │<─────────────────────────────────────────────│                           │
     │      null      │                   │                 │                              │                           │
     │<───────────────────────────────────│  (返回null表示已删除)                          │                           │
     │                │                   │                 │                              │                           │
     │  提交事务       │                   │                 │                              │                           │
     │───────────────>│                   │                 │                              │                           │
     │                │ commit()          │                 │                              │                           │
     │                │──────────────────────────────────────────────────────────────────>│                           │
     │                │                   │                 │                              │ 批量提交                   │
     │                │                   │                 │                              │─────────────────────────>│
     │                │                   │                 │                              │            OK            │
     │                │                   │                 │                              │<─────────────────────────│
     │       OK       │                   │                 │                              │                           │
     │<───────────────│                   │                 │                              │                           │
     │                │                   │                 │                              │                           │
```

---

## 5. 配置和使用

### 5.1 @Table 注解配置

```java
@Table(
    value = "cms_admin_user",           // 表名
    DB = DBType.sys,                    // 数据库
    useTableCache = true,               // 启用表缓存
    cacheNullValue = false,             // 是否缓存 null 值
    useSelectAll = true,                // 是否启用 selectAll 缓存
    cacheExpire = 24 * 3600,           // 缓存过期时间（秒），默认 24 小时
    primaryKey = {"adminId"}            // 主键字段，默认 "id"
)
public interface AdminUserMapper {
    
    int insert(AdminUser record);
    
    int updateByPrimaryKey(AdminUser record);
    
    int updateByPrimaryKeySelective(AdminUser record);
    
    int deleteByPrimaryKey(Long adminId);
    
    AdminUser selectByPrimaryKey(Long adminId);
    
    @SelectAll
    List<AdminUser> selectAll();
}
```

### 5.2 自动配置类

```java
@AutoConfiguration
@Conditional(TableRedisCondition.class)
public class TableCacheAutoConfig {

    /**
     * 缓存实现类，链路：BufferedCache -> RedisCache -> Redis
     */
    @Bean
    public ICache iCache(@Qualifier("tableSpringBootRedisTemplate") RedisTemplate<String, String> redisTemplate) {
        ICache cache = new RedisCache(redisTemplate);
        ICache bufferedCache = new BufferedCache(cache, redisTemplate);
        return bufferedCache;
    }

    /**
     * 表缓存执行器
     */
    @Bean
    public CacheExecutor dataProxy(ICache cache) {
        Serializer serializer = new FastJsonSerializable();
        CacheManager cm = new CacheManager(cache, serializer);
        return new CacheExecutor(cm);
    }

    /**
     * 表缓存切面拦截器
     */
    @Bean
    public TableCacheAspect tableCacheAspect() {
        return new TableCacheAspect();
    }
}
```

---

## 6. 命令类型说明

`Command` 类支持以下操作类型：

| 操作 | 说明 | 对应 Redis 命令 |
|------|------|----------------|
| `SET` | 设置缓存值 | `SET key value` |
| `SETEX` | 设置带过期时间的缓存值 | `SETEX key seconds value` |
| `DEL` | 删除缓存 | `DEL key` |
| `EXPIRE` | 设置过期时间 | `EXPIRE key seconds` |
| `SETS` | 批量设置缓存值 | `MSET key1 value1 key2 value2 ...` |

---

## 7. 缓存一致性保证

### 7.1 非事务场景

- 增删改操作：先执行数据库操作，成功后立即删除缓存
- 查询操作：先查缓存，未命中则查数据库并写入缓存

### 7.2 事务场景

- 增删改操作产生的缓存命令会被暂存到缓冲区
- 事务中的查询会优先从缓冲区读取（保证读已提交的数据一致性）
- 事务提交时：所有缓存命令批量执行（Redis 事务或 Pipeline）
- 事务回滚时：清空缓冲区，不执行任何缓存操作

### 7.3 注意事项

1. 缓存采用**删除策略**而非更新策略，避免并发更新导致的数据不一致
2. 事务资源按 `order()` 排序执行，表缓存资源 order 为 -1，优先执行
3. 如果 Redis 不支持事务模式，会自动降级为 Pipeline 模式
4. 数据库事务提交成功后，Redis 命令才会执行，保证最终一致性

---

## 8. 相关类索引

### 8.1 表缓存模块目录结构

[core/config/cache/table/](../module-commons/commons-core/src/main/java/com/devvv/commons/core/config/cache/table) 目录结构
```
config/cache/table/
├── annotation/                                      # 注解定义
│   └── SelectAll.java                               # 标记全表查询方法，启用 selectAll 缓存
│
├── cache/                                           # 缓存实现层
│   ├── ICache.java                                  # 缓存接口，定义 get/set/del 等基础操作
│   ├── RedisCache.java                              # Redis 缓存实现，直接操作 Redis
│   ├── buffer/                                      # 事务缓冲区
│   │   ├── BufferedCache.java                       # 装饰器模式，事务中暂存命令到缓冲区
│   │   └── BufferedTableCacheTransactionResource.java  # 事务资源，管理命令缓冲区的提交/回滚
│   └── command/                                     # 命令模型
│       ├── Command.java                             # 缓存命令对象（SET/SETEX/DEL/EXPIRE/SETS）
│       └── CommandParser.java                       # 命令解析器，事务提交时批量执行 Redis 命令
│
├── config/                                          # 配置与切面
│   ├── TableCacheAutoConfig.java                    # 自动配置类，装配缓存组件 Bean
│   ├── TableCacheAspect.java                        # AOP 切面，拦截 Mapper 方法进行缓存处理
│   └── FastJsonSerializable.java                    # FastJson 序列化实现
│
├── manager/                                         # 业务管理层
│   ├── CacheExecutor.java                           # 【核心】缓存执行器，协调缓存读写与数据库操作
│   ├── CacheManager.java                            # 缓存管理器，封装序列化/反序列化与缓存 CRUD
│   ├── Delegater.java                               # 代理接口
│   └── MethodDefaultDelegater.java                  # 默认方法代理实现
│
├── exception/                                       # 异常定义
    ├── CacheException.java                          # 缓存操作异常
    └── DataProxyException.java                      # 数据代理异常
```

### 8.2 事务管理相关类（位于 `config/datasource/transaction/busi/`）

```
config/datasource/transaction/busi/
├── BusiTransactionManager.java                      # 业务事务管理器，继承多数据源事务管理器
├── BusiTransactionResourceManager.java              # 事务资源管理器，ThreadLocal 管理事务资源绑定
└── BusiTransactionResource.java                     # 事务资源接口，定义 commit/rollback 方法
```

### 8.3 表注解（位于 `config/datasource/annotation/`）

```
config/datasource/annotation/
└── Table.java                                       # @Table 注解，配置表名、主键、缓存策略等
```
